# 设计文档：执行核心与安全保障 (v1)

## 1. 引言与目标

ComfyTavern 平台的核心功能之一是执行复杂的工作流，并将这些能力通过应用面板或 API 暴露出来。本 文档旨在详细阐述工作流的执行流程，特别是从接收输入到后端执行的完整链路，以及为确保整个过程的安全性所采取的各项保障措施。

**目标**:

*   定义应用面板（微应用）的安全沙盒运行环境。
*   详细描述输入值如何安全地注入到预定义的工作流中。
*   阐述直接执行原始工作流定义时的关键安全校验机制。
*   概述平台通用的安全保障措施，确保数据和系统的完整性与可靠性。

## 2. 应用面板（微应用）沙盒环境与安全

应用面板作为独立的微型 Web 应用，其运行环境的安全性至关重要。

*   **2.1. `<iframe>` 沙盒化执行**
    *   所有应用面板的 UI 都在一个 `<iframe>` 元素中加载和运行。
    *   `<iframe>` 的 `sandbox` 属性将根据面板 `PanelDefinition` 中的 `uiRuntimeConfig.sandboxAttributes` 或平台默认的严格策略进行配置。
        *   **最小权限原则**：默认应仅开启必要的权限（如 `allow-scripts`），其他如 `allow-same-origin` (除非面板资源与主应用同源且受信任，或面板内部资源引用确实需要，并已评估风险), `allow-forms`, `allow-popups`, `allow-top-navigation` 等应谨慎开启。
        *   平台应提供清晰的指导，帮助面板创作者理解各 `sandbox` 属性的含义和安全影响。
*   **2.2. 特性权限 (`featurePermissions`)**
    *   面板可以通过 `PanelDefinition.uiRuntimeConfig.featurePermissions` 声明其需要的特定浏览器特性或 API（如 `webgl`, `webaudio`, `gamepad`, `clipboard-read`, `fullscreen`）。
    *   平台可以根据这些声明，结合 `<iframe>` 的 `allow` 属性 (Feature Policy)，对面板的能力进行更细致的控制。用户也可能需要对某些敏感权限进行授权。
*   **2.3. 内容安全策略 (CSP)**
    *   应为加载面板的 `<iframe>` 设置严格的 CSP 头部，以减少跨站脚本（XSS）和其他注入攻击的风险。
    *   CSP 策略应尽可能限制脚本来源、样式来源、连接来源等。例如：`default-src 'self'; script-src 'self' 'unsafe-inline' panel-source.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' api.comfytavern.com; frame-ancestors 'self';` (示例，需根据实际情况调整)。
    *   主应用本身也应有健壮的 CSP 配置。
*   **2.4. 与宿主的安全通信**
    *   面板通过 `window.postMessage` API 与宿主框架（注入 `window.comfyTavernPanelApi` 的那一层）进行通信。
    *   通信双方必须验证消息来源 (`event.origin`)，确保消息来自预期的对方。
    *   `window.comfyTavernPanelApi` 的注入过程本身需要安全，防止被恶意页面篡改。

## 3. 核心执行流程：从输入到执行

### 3.1. 流程概述 (针对预定义工作流)

1.  **用户输入**: 用户在应用面板 UI 中提供输入，或第三方应用通过 HTTP API 提供输入 (`interfaceInputValues`)。
2.  **API 调用**:
    *   面板 JS 调用 `comfyTavernPanelApi.executeWorkflow(workflowId, panelInputs)`。
    *   第三方应用调用 `POST /api/v1/workflows/{workflowId}/execute` 并提供 `interfaceInputValues`。
3.  **代理层处理 (前端或API网关)**:
    *   接收请求，验证权限和输入（初步校验）。
    *   加载目标 `workflowId` 的原始工作流定义（例如，VueFlow 元素结构）。
4.  **输入注入 (关键步骤)**:
    *   代理层创建工作流元素定义的副本。
    *   找到代表工作流公共接口的顶层 `core:GroupInput` 节点。
    *   遍历调用方提供的 `interfaceInputValues` (或 `panelInputs`)。
    *   对于每个输入值，查找从 `core:GroupInput` 对应输出槽（由 `interfaceInput` 的 `id` 或 `name` 标识）出发的连接，定位到直接连接的下游节点及其目标输入槽。
    *   将输入值安全地写入这些直接下游节点的输入数据结构中（例如，更新 `targetNode.data.inputs[targetSlotKey].value` 或 `targetNode.inputValues[targetSlotKey]`，具体取决于前端数据模型和后续转换逻辑）。
    *   **安全性**: 此过程必须防止注入攻击，例如，如果输入值是字符串，应确保其不会被错误地解释为代码或特殊指令。类型检查和清理是必要的。
    *   （可选）顶层的 `core:GroupInput` 节点及其出边在注入完成后，可以从待处理的元素列表中移除，因为它定义接口和引导注入的功能已完成。或者保留，但确保其后端执行无副作用或不处理这些已被前端注入的值。
5.  **工作流预处理 (前端或代理层)**:
    *   对已注入输入的工作流元素列表执行必要的预处理，例如：
        *   扁平化 (`flattenWorkflow`): 解析节点组，将嵌套结构展开。
        *   转换为核心格式 (`transformVueFlowToCoreWorkflow`, `transformVueFlowToExecutionPayload`): 将前端的 VueFlow 格式转换为后端执行引擎可理解的格式。
        *   构建输出接口映射 (`outputInterfaceMappings`): 确定 `core:GroupOutput` 节点的输出如何映射回 `interfaceOutputs`。
6.  **提交到后端**:
    *   通过 WebSocket (`PROMPT_REQUEST`) 或内部 API 调用，将处理后的工作流执行载荷发送给后端执行引擎。
7.  **后端执行**:
    *   后端执行引擎接收请求，进行最终校验（见 4.2 节），然后调度和执行工作流中的各个节点。
    *   通过 WebSocket 或其他机制返回执行状态、中间结果和最终输出。
8.  **结果传递**:
    *   代理层接收来自后端的消息，通过 `comfyTavernPanelApi` 的回调函数转发给应用面板 JS，或作为 HTTP API 的响应返回给第三方调用者。
9.  **UI 更新**: 应用面板根据接收到的数据更新其用户界面。

### 3.2. 后端 `core:GroupInput` 节点的角色

*   在上述输入注入主要由前端/代理层处理的模式下，当工作流定义到达后端时，`core:GroupInput` 节点的主要职责可能已经完成（即定义接口和引导前端注入）。
*   其后端的 `execute` 方法应设计为：
    *   如果该节点在预处理中被移除，则无操作。
    *   如果保留，则其应仅传递通过其自身 `configValues` 或特殊内部 `inputs` 预设的值（如果有的话），而不应尝试重新处理那些已被前端注入到下游节点的值，以避免冲突或重复处理。

## 4. 直接原始工作流定义的执行与安全

当调用方通过 `POST /api/v1/execute_raw_workflow` 直接提交一个完整的工作流 JSON 定义时，安全保障的重心主要在后端。

*   **4.1. 调用方责任**: 调用方负责构建一个结构正确、逻辑完整且符合后端期望格式的 `workflow_json`。
*   **4.2. 后端严格校验机制**: 后端在接收到 `workflow_json` 后，执行前必须进行一系列严格的校验：
    *   **JSON 结构与格式验证**: 确保提交的是合法的 JSON，并且符合后端工作流定义的基本模式。
    *   **节点类型白名单/黑名单**:
        *   维护一个允许执行的节点类型列表（白名单），或一个禁止执行的节点类型列表（黑名单）。
        *   优先使用白名单机制，仅允许已知的、经过安全审查的节点类型被执行。
        *   严禁执行能够直接操作文件系统、执行任意shell命令、发起不受控制的网络请求或访问敏感系统资源的“不安全”节点，除非调用者拥有极特殊的、明确授予的权限。
    *   **节点配置验证**: 对每个节点的配置参数进行验证，确保其值在预期范围内，类型正确，且不包含恶意内容。
    *   **连接关系验证**: 检查节点间的连接是否有效，是否存在循环依赖（如果业务逻辑不允许）等。
    *   **资源消耗预估与限制 (可选但推荐)**:
        *   尝试根据工作流的节点数量、类型、复杂度等预估其可能的资源消耗（CPU、内存、执行时间）。
        *   设置合理的上限，防止单个请求耗尽系统资源，导致拒绝服务 (DoS)。例如，限制最大节点数、最大嵌套深度、最长预计执行时间等。
    *   **输入数据校验与清理**: 如果请求中包含 `inputs` 用于覆盖工作流中的初始值，这些输入值也必须经过严格的校验和清理，防止注入攻击。
    *   **权限校验**: 确保发起调用的 API Key 或用户具有执行原始工作流的权限，甚至可能需要更细粒度的权限来控制可使用的节点类型或资源量。
    *   **禁止动态代码执行**: 确保工作流执行过程中不会加载和执行来自不可信来源的动态代码（例如，脚本节点中的代码应来自受信任的库或经过严格审查）。
*   **4.3. 安全执行环境**: 后端节点执行也应在一定的沙盒或隔离环境中进行，限制其对系统资源的访问。

## 5. 通用安全保障措施

以下措施适用于平台的所有组件和交互流程：

*   **API 输入全面验证**: 所有外部输入（来自面板、HTTP API 调用等）在被处理前都必须经过严格的验证（类型、格式、范围、内容）。
*   **身份认证与授权**:
    *   所有需要保护的 API 和操作都必须进行身份认证。
    *   基于角色或权限的访问控制 (RBAC/PBAC)，确保用户和 API Key 只能访问其被授权的资源和功能。
*   **速率限制**: 对 API 调用和敏感操作实施速率限制，防止暴力破解和滥用。
*   **日志与监控**:
    *   记录详细的操作日志和安全事件日志（如认证失败、授权拒绝、潜在的攻击尝试、关键错误等）。
    *   建立监控和告警机制，及时发现和响应安全事件。
*   **错误处理**:
    *   错误信息应设计为对用户友好，但不泄露过多敏感的系统内部细节或堆栈跟踪。
    *   统一的错误响应格式。
*   **依赖项安全管理**: 定期扫描和更新项目的所有依赖库，修复已知的安全漏洞。
*   **传输层安全 (TLS/HTTPS)**: 所有通过公共网络传输的数据（包括面板与宿主、API 调用、前后端通信）都必须使用 HTTPS 加密。
*   **定期安全审计与渗透测试**: 主动发现和修复潜在的安全漏洞。

## 6. 对现有模块的潜在修改回顾

*   **`useWorkflowExecution.ts` (前端)**:
    *   其 `executeWorkflow` 方法需要能够被代理层以更程序化的方式调用。
    *   应能清晰地接收预处理（已由代理层完成输入注入）的工作流元素列表，或者直接接收 `interfaceInputValues` 和 `workflowId`，由其内部协调输入注入和后续的扁平化、转换。设计上应倾向于让代理层处理输入注入，`useWorkflowExecution` 专注于后续流程。
*   **前端路由/视图管理**:
    *   当项目的 `preferredView` 为 "custom" 时，加载“面板宿主”组件，该组件负责创建 `iframe`、加载面板 `uiEntryPoint`、注入 `comfyTavernPanelApi` 并建立安全的通信桥梁。