# ComfyTavern 双轨扩展架构：应用面板与原生插件

## 1. 核心理念：安全与自由的平衡

ComfyTavern 旨在构建一个强大、开放且安全的 AI 应用生态。为了同时满足不同层次开发者的需求，我们借鉴游戏引擎的设计哲学，采用一种双轨制、分层次的扩展架构。

该架构包含两种核心扩展模式：

1.  **应用面板 (Application Panels)**：以**安全隔离**为首要原则，为广大应用创作者提供一个稳定、易用、跨平台的开发环境。
2.  **原生插件 (Native Plugins)**：以**极致性能和自由度**为核心，为高级开发者和核心贡献者提供深入定制和扩展平台底层能力的“root”权限。

这两种模式并行存在，共同构成了 ComfyTavern 繁荣、稳固的生态系统。

---

## 2. 体系一：应用面板 (The App Store Model)

### 2.1 定位与目标用户

-   **定位**：官方、安全的“应用商店”模式。
-   **目标用户**：绝大多数应用开发者，包括但不限于：
    -   交互式应用（如 AI 聊天、视觉小说）的创作者。
    -   轻量级工具（如自动化脚本、数据处理器）的开发者。
    -   希望快速将工作流封装为图形化界面的用户。

### 2.2 架构设计

-   **运行环境**：面板在 HTML `<iframe>` 沙盒中运行，与主应用程序完全隔离。
-   **通信机制**：通过 `window.postMessage` API 与主程序（宿主）进行异步、安全的双向通信。所有通信都遵循在 `panel-api-specification.md` 中定义的标准化协议。
-   **技术栈**：开发者可以使用任何现代 Web 技术（Vue, React, Svelte, Solid, Vanilla JS, WASM, Three.js 等）来构建面板的用户界面和逻辑。

### 2.3 开发者体验：`@comfytavern/panel-sdk`

为了消除 `postMessage` 的复杂性，我们计划提供一个官方的 **面板开发工具包 (Panel SDK)**。

-   **核心功能**：将底层的通信协议封装成一个简单、直观的 JavaScript/TypeScript 库。
-   **使用方式**：开发者只需 `import { panelApi } from '@comfytavern/panel-sdk'`，即可像调用本地模块一样与宿主环境交互。
-   **优点**：
    -   **类型安全**：提供完整的 TypeScript 类型定义，支持自动补全和编译时检查。
    -   **Promise-based**：所有异步操作都返回 Promise，符合现代 JS 异步编程习惯。
    -   **事件订阅**：提供简洁的 API 用于订阅来自宿主的事件（如工作流进度、结果、错误等）。
    -   **无需关心底层细节**：开发者可以专注于业务逻辑，而无需手动管理请求 ID、监听事件和处理消息格式。

### 2.4 安全性与分发

-   **安全性**：极高。沙盒机制从根本上杜绝了面板访问或破坏主程序内部状态、文件系统或敏感数据（如用户 API Keys）的可能性。面板的崩溃不会影响主程序的稳定性。
-   **分发**：极其便利。一个应用面板本质上是一个独立的静态网站资源包，可以通过 URL 轻松分享、加载，或打包成文件分发。

---

## 3. 体系二：原生插件 (The Engine Modding Model)

### 3.1 定位与目标用户

-   **定位**：底层、高性能的“引擎魔改”模式。
-   **目标用户**：
    -   希望深度定制平台功能的高级开发者。
    -   需要最高性能、最低延迟的核心功能贡献者。
    -   希望将 ComfyTavern 与其他系统（如数据库、外部服务）进行深度集成的开发者。

### 3.2 架构设计

-   **运行环境**：插件代码（TypeScript/JavaScript）被直接加载到 ComfyTavern 的**主进程**中运行，与核心代码拥有相同的权限。
    -   **前端插件**：在 Vue 应用实例的上下文中运行。
    -   **后端插件**：在 Elysia/Bun 应用实例的上下文中运行。
-   **加载机制**：ComfyTavern 启动时，会扫描 `plugins/` 目录，解析每个插件的 `plugin.json` 清单文件，并动态 `import()` 其指定的入口点文件。

### 3.3 插件清单与 API

-   **插件清单 (`plugin.json`)**：每个插件必须包含一个清单文件，声明其 ID、版本、作者、描述以及前后端入口点。
-   **插件 API (`pluginApi`)**：我们将提供一个权限远大于 `panelApi` 的 `pluginApi`，用于插件与主程序交互。
    -   **前端 `pluginApi`**：提供访问 Vue app 实例、Pinia stores、全局事件总线、UI 组件注册器等能力。
    -   **后端 `pluginApi`**：提供访问 Elysia app 实例、WebSocket 管理器、节点类型注册表、工作流执行器等核心服务的能力。

### 3.4 安全性与分发

-   **安全性**：低。插件拥有与主程序同等的权限，一个恶意的或编写不当的插件可能导致数据泄露、程序崩溃甚至安全漏洞。
-   **用户警示**：在加载或安装原生插件时，必须向用户显示明确的**安全警告**，强调其高风险性，并要求用户确认信任插件来源。
-   **分发**：通过直接放置文件到 `plugins/` 目录进行。适用于开发者自用或在受信任的社区中分发。

---

## 4. 总结对比

| 特性 | 应用面板 (Panel) | 原生插件 (Plugin) |
| :--- | :--- | :--- |
| **核心理念** | 安全、易用、隔离 | 自由、性能、集成 |
| **目标用户** | 应用创作者、UI 设计师 | 核心开发者、系统集成者 |
| **运行环境** | `<iframe>` 沙盒 | 主进程 (前端/后端) |
| **性能** | 有通信开销，适合 UI 交互 | 原生性能，无开销 |
| **访问权限** | 严格受限，通过 `panelApi` | 完全权限，通过 `pluginApi` |
| **安全性** | ✅ 非常高 | ⚠️ 低（需要用户信任） |
| **技术栈** | 任何 Web 技术 | TypeScript / JavaScript |
| **分发方式** | URL 或资源包，易于分享 | 文件分发，需手动安装 |
| **使用场景** | 聊天机器人、视觉小说、数据可视化 | 新节点类型、数据库集成、核心功能修改 |

## 5. 实施路线图（初步）

1.  **阶段一：完善应用面板体系**
    -   [ ] 设计并实现 `@comfytavern/panel-sdk` 的核心功能。
    -   [ ] 完善宿主环境对 `panelApi` 协议的响应逻辑。
    -   [ ] 创建一个或多个应用面板模板项目。
2.  **阶段二：构建原生插件体系基础**
    -   [ ] 实现插件加载器，用于在启动时扫描 `plugins/` 目录并加载插件。
    -   [ ] 定义 `plugin.json` 的最终格式。
    -   [ ] 设计并实现前后端 `pluginApi` 的初始版本。
3.  **阶段三：生态建设**
    -   [ ] 撰写详细的开发者文档，分别面向面板开发者和插件开发者。
    -   [ ] 创建示例面板和示例插件，展示两种模式的最佳实践。